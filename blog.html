<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link rel="stylesheet" href="blog.css" />
    <title>Blogsite</title>
    <style>
      .card {
        color: black !important;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="con">
        <div class="floatingImg">
          <img
            src="./media/27bde6ed0ff5392cc0cd682cceb62eea-removebg-preview.png"
            alt=""
          />
        </div>
        <div class="floatingImg2">
          <img
            src="./media/d0b10ea4413d686e98921669af809f2c-removebg-preview.png"
            alt=""
          />
        </div>
        <!-- <div class="side-imgCon"></div> -->
        <div class="side-imgCon2"></div>
        <div class="nav">
          <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
              <a class="navbar-brand ms-5" href="#">Echoes</a>
              <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNav"
                aria-controls="navbarNav"
                aria-expanded="false"
                aria-label="Toggle navigation"
              >
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                  <li class="nav-item ms-3">
                    <a class="nav-link" aria-current="page" href="signup.html"
                      >Home</a
                    >
                  </li>
                  <li class="nav-item ms-3">
                    <a class="nav-link" href="#">About</a>
                  </li>
                  <li class="nav-item ms-3">
                    <button
                      class="btn btn-primary userProfileCon"
                      type="button"
                      data-bs-toggle="offcanvas"
                      data-bs-target="#offcanvasRight"
                      aria-controls="offcanvasRight"
                    >
                      <img
                        class="userProfile"
                        src="https://i.pinimg.com/1200x/e8/d7/d0/e8d7d05f392d9c2cf0285ce928fb9f4a.jpg"
                        alt=""
                      />
                    </button>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
        </div>
        <div
          class="offcanvas offcanvas-end"
          tabindex="-1"
          id="offcanvasRight"
          aria-labelledby="offcanvasRightLabel"
        >
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasRightLabel">Echoes</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="offcanvas"
              aria-label="Close"
            ></button>
          </div>
          <div class="offcanvas-body">
            <p class="mx-auto" onclick="Profile()" id="profile">Profile</p>
            <p class="mx-auto">Get Preminum</p>
            <p class="mx-auto">Settings</p>
            <p class="mx-auto">ExtraInfo</p>
            <p class="mx-auto" onclick="Logout()" id="logout">Logout</p>
          </div>
        </div>
        <div class="postCon mt-5 pt-4 d-flex mb-5">
          <div class="welcome mt-5 ps-5 pt-5">
            Hi
            <span id="username"></span>! <br />Welcome backðŸ˜Š
          </div>
          <div class="form mt-4 mx-auto">
            <div class="header">Want to post a blog?</div>
            <div class="title">
              <input
                type="text"
                placeholder="Enter blog title"
                id="title"
                oninput="checkInputs()"
              />
            </div>
            <div class="blogContent">
              <input
                type="text"
                placeholder="What do you want to post?"
                id="postBlog"
                oninput="checkInputs()"
              />
            </div>
            <div class="toupload">
              <label for="addImage" class="addbtn">Add Image</label>
              <input type="file" accept=".png, .jpg" multiple id="addImage" />
            </div>
            <div class="uploadButton">
              <button onclick="uploadBlog()" id="upload" disabled>
                Upload
              </button>
            </div>
          </div>
        </div>
        <div class="output"></div>
      </div>
    </div>
  </body>
</html>
<script>
  let usersDatabase =
    JSON.parse(localStorage.getItem("blogUsersDatabase")) || [];
  let blogImagesStorage =
    JSON.parse(localStorage.getItem("blogImagesStorage")) || [];
  let curentUserIndex = JSON.parse(localStorage.getItem("blogUserIndex"));
  let currentUser = usersDatabase[curentUserIndex];

  let title = document.getElementById("title");
  let postBlog = document.getElementById("postBlog");
  let upload = document.getElementById("upload");

  function checkUserAuth() {
    if (!currentUser) {
      document.body.innerHTML = "";
      alert("Unauthorised User, please login ");
      window.location.href = "login.html";
    }
  }

  function checkBlogUser() {
    if (!currentUser) {
      document.body.innerHTML = "";
      alert("Unauthorised User, please sign up");
      window.location.href = "signup.html";
      return;
    }
  }
  checkBlogUser();

  function displayBloggerName() {
    let username = document.getElementById("username");
    username.innerHTML = `${currentUser.accountName}`;
  }
  displayBloggerName();

  previousTitle = "";
  previousBody = "";
  function Profile() {
    let profile = document.getElementById("profile");
    let offcanvas_title = document.querySelector(".offcanvas-title");
    let offcanvas_body = document.querySelector(".offcanvas-body");
    let navProfilePic = document.querySelector(".userProfile");

    previousTitle = offcanvas_title.innerHTML;
    previousBody = offcanvas_body.innerHTML;

    offcanvas_title.innerHTML = "Update Profile Picture";
    offcanvas_body.innerHTML = `
      <div class="default ">
        <button onclick="takeBack()" class='takeback'>
          <span class="material-symbols-outlined"> arrow_back </span>
        </button>
        <img
        id="userProfilePreview"
        src="https://i.pinimg.com/1200x/e8/d7/d0/e8d7d05f392d9c2cf0285ce928fb9f4a.jpg"
        alt=""
        />
      </div>
      <form action="" id="pictureSetting">
        <label for="addUserPic" id='changeUserPic'>Update Picture</label>
        <input type="file" id="addUserPic" accept =".jpg, .png">
      </form>
    `;

    let fileInput = document.getElementById("addUserPic");
    let preview = document.getElementById("userProfilePreview");

    fileInput.addEventListener("change", () => {
      let pic = fileInput.files[0];

      if (pic) {
        let reader = new FileReader();
        reader.onload = (event) => {
          let base = event.target.result;
          localStorage.setItem("profilePic", base);

          navProfilePic.src = base;
          preview.src = base;
        };
        reader.readAsDataURL(pic);
      }
    });
    let savedPic = localStorage.getItem("profilePic");
    if (savedPic) {
      navProfilePic.src = savedPic;
      preview.src = savedPic;
    }
  }
  window.addEventListener("load", () => {
    let savedPic = localStorage.getItem("profilePic");
    if (savedPic) {
      document.getElementById("profile").src = savedPic;
    }
    let preview = document.getElementById("userProfilePreview");
    if (preview) {
      preview.src = savedPic;
    }
  });

  function takeBack() {
    let offcanvas_title = document.querySelector(".offcanvas-title");
    let offcanvas_body = document.querySelector(".offcanvas-body");

    offcanvas_title.innerHTML = previousTitle;
    offcanvas_body.innerHTML = previousBody;
  }

  // function changeUserPP() {
  //   let userProfile = document.getElementById("userProfile");
  //   let changePP = document.getElementById("toChangePP");
  //   userProfile.addEventListener("click", () => {
  //     changePP.click();
  //   });
  // }

  function checkInputs() {
    if (!title.value.trim() || !postBlog.value.trim()) {
      // alert('Please fill the fields')
      upload.disabled = true;
    } else {
      upload.disabled = false;
    }
  }

  function displayblogContent() {
    let output = document.querySelector(".output");
    output.innerHTML = "";
    for (let index = 0; index < currentUser.blogDatabase.length; index++) {
      let blog = currentUser.blogDatabase[index];
      let imageHTML = "";
      let picP = "";
      blog.pictures.forEach((pic) => {
        let picP = blogImagesStorage[pic];
        imageHTML += `
          <img src="${picP}" class="card-img-top mx-2" class='blog-image' alt="..." />
          `;
      });
      let likeText = blog.liked ? "Liked" : "Like";
      output.innerHTML += `
              <div class="card mx-auto mt-3" style="width: 30rem">
                <div class="imageCon d-flex "> ${imageHTML}</div>
                <div class="card-body">
                  <h5 class="card-title">${blog.blogTitle}</h5>
                  <p class="card-text">
                    ${blog.blogContent}
                  </p>
                  <div class="buttons">
                    <button id="like" class='like' onclick= 'likeBlog(${index})'>${likeText}</button>
                    <button id="delete" onclick= 'deleteBlog(${index})'>Delete</button>
                  </div>
                </div>
              </div>
              `;
    }
  }
  displayblogContent();

  function likeBlog(index) {
    let blog = currentUser.blogDatabase[index];

    // alert('You liked this blog')
    blog.liked = !blog.liked;
    localStorage.setItem("blogUsersDatabase", JSON.stringify(usersDatabase));
    displayblogContent();
  }

  function deleteBlog(index) {
    if (confirm("Are you sure you want to delete this blog?")) {
      currentUser.blogDatabase.splice(index, 1);

      localStorage.setItem("blogUsersDatabase", JSON.stringify(usersDatabase));
      displayblogContent();
    }
  }

  function uploadImage(callback) {
    let addImage = document.getElementById("addImage").files;
    let filesArray = Array.from(addImage);
    let pictureIndex = [];

    if (filesArray.length > 2) {
      alert("You can only upload two pictures");
      return;
    }
    if (filesArray.length === 0) {
      callback([]);
      return;
    }
    let loaded = 0;

    filesArray.forEach((file) => {
      let reader = new FileReader();
      reader.readAsDataURL(file);
      reader.addEventListener("load", (ev) => {
        blogImagesStorage.push(ev.target.result);
        console.log(ev.target.result);
        let index = blogImagesStorage.length - 1;
        pictureIndex.push(index);

        // blogImage.src = pictures[loaded];
        loaded++;

        if (loaded === filesArray.length) {
          localStorage.setItem(
            "blogImagesStorage",
            JSON.stringify(blogImagesStorage)
          );
          callback(pictureIndex);
        }
      });
    });
  }

  function displayImage() {
    let blogImage = document.getElementById("image");
    let imageCon = document.querySelector(".imageCon");
  }

  function uploadBlog() {
    alert("Uploading successful");
    uploadImage(function (pictures) {
      let blogDetails = {
        blogTitle: title.value.trim(),
        blogContent: postBlog.value.trim(),
        pictures: pictures,
      };
      blogDetails.pictures = pictures;

      // Save blog
      currentUser.blogDatabase.push(blogDetails);

      localStorage.setItem("blogUsersDatabase", JSON.stringify(usersDatabase));

      // Refresh display
      displayblogContent();
    });
  }
  const offcanvasElementList = document.querySelectorAll(".offcanvas");
  const offcanvasList = [...offcanvasElementList].map(
    (offcanvasEl) => new bootstrap.Offcanvas(offcanvasEl)
  );

  function Logout() {
    let confirmLogout = window.confirm("Are you sure you want to log out?");
    if (confirmLogout) {
      localStorage.removeItem("blogUserIndex");
      window.location.href = "login.html";
    }
  }
</script>
